#! /usr/bin/env bash

RESTORE='\033[0m'
RED='\033[00;31m'
GREEN='\033[00;32m'
YELLOW='\033[00;33m'
BLUE='\033[00;34m'
BOLD=$(tput bold)
NORMAL=$(tput sgr0)

help() {
	echo "${BOLD}ABOUT${NORMAL}"
	echo "  pvenv utilises direnv & venv to create a virtual environment for"
	echo "  Python projects."
	echo
	echo "${BOLD}USAGE${NORMAL}"
	echo "  $(basename "$0") [options] (path)"
	echo
	echo "${BOLD}OPTIONS${NORMAL}"
	echo "  -h/--help:   Shows this help message"
	echo "  -c/--clear:  Clear the target directory"
	echo
	echo "${BOLD}PATH${NORMAL}"
	echo "  Path to directory that'll become your Python environment. A directory"
	echo "  with an existing .envrc is valid - if .envrc does not exist, it will"
	echo "  be created."
	echo
	echo "  Once an .envrc file has been created, direnv can grant the user"
	echo "  permission to read the environment variables defined in the .envrc"
	echo "  and allow the users' shell access to them."
	echo
	echo "  Then we can begin setting up a Python virtual environment, and"
	echo "  set PATH appropriately so that our local python binary is available."
	exit 0
}

parse_opts() {
	optstring=":hc"
	while getopts ${optstring} arg; do
		case "$arg" in
		h)
			help
			;;
		c)
			echo -e "${RED}Contents of target directory will be ${BOLD}DELETED!${NORMAL}"
			echo "Proceed? (y/N)"

			read -rn 1 confirmed
			if [[ "$confirmed" != "y" ]]; then
				exit
			fi
			;;
		*)
			help
			;;
		esac
	done
}

parse_opts

# Target path must be a directory
path="$2"
if [[ -d "$path" ]]; then

	# Invalid permissions on target directory
	if [[ ! -w "$path" ]]; then
		echo "${RED}Directory not writable, exiting${RESTORE}"
		exit 1
	fi

	envrc="$path"/.envrc
	if [[ -f "$envrc" ]]; then
		echo "Found .envrc"
	else
		echo "Creating .envrc"
		touch "$envrc" || exit $?
	fi
else
	help
fi

# if [ -n "$1" ]; then
# 	envrc="$1"/.envrc
# 	dir="$1"
# 	if [[ -f $1 ]]; then
# 		envrc="$1"
# 		dir="$(
# 			builtin cd "$1" || echo "No dir, where the fuck am I?" && exit 1
# 			pwd
# 		)"
# 		touch "$envrc"
# 	else
# 		touch "$envrc"
# 	fi
# else
# 	echo "$usage" && exit 1
# fi
#
# touch "$envrc" && asdf exec direnv allow
# $EDITOR "$envrc"
# python -m venv "$dir"
# source "$dir"/bin/activate
